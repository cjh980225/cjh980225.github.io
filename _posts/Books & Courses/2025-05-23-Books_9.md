# êµ¬ë§¤ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìƒí’ˆ ì¶”ì²œí•˜ê¸°

## íƒìƒ‰ì  ë¶„ì„ : UK Retail ë°ì´í„° ë¶„ì„í•˜ê¸° 

|ë³€ìˆ˜|ë‚´ìš©|
|-|-|
|InvoiceNo|ê±°ë˜ ê³ ìœ  ë²ˆí˜¸|
|StockCode|ìƒí’ˆ ê³ ìœ  ë²ˆí˜¸|
|Description|ìƒí’ˆëª…|
|Quantity|ê±°ë˜ ìˆ˜ëŸ‰|
|InvoiceDate|ê±°ë˜ ì¼ì‹œ|
|UnitPrice|ìƒí’ˆ ë‹¨ê°€|
|CustomerID|êµ¬ë§¤ì ê³ ìœ  ë²ˆí˜¸|
|Country|êµ¬ë§¤ êµ­ê°€|

ğŸ” ë°ì´í„°ì…‹ ì‚´í´ë³´ê¸°


```python
# -*- coding : utf-8 -*- 
%matplotlib inline 

import pandas as pd 
import numpy as np 
import matplotlib.pyplot as plt 

import warnings 
warnings.filterwarnings("ignore")

# ì˜êµ­ ì˜¨ë¼ì¸ ìŠ¤í† ì–´ ë„ë§¤ ê±°ë˜ ë°ì´í„° 
df = pd.read_csv("./data/online_retail.csv", dtype = {'CustomerID' : str, 
                                                     'InvoiceID' : str}, encoding = "ISO-8859-1")
df['InvoiceDate'] = pd.to_datetime(df['InvoiceDate'], format = "%m/%d/%Y %H:%M")
print(df.info())
df.head()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 541909 entries, 0 to 541908
    Data columns (total 8 columns):
     #   Column       Non-Null Count   Dtype         
    ---  ------       --------------   -----         
     0   InvoiceNo    541909 non-null  object        
     1   StockCode    541909 non-null  object        
     2   Description  540455 non-null  object        
     3   Quantity     541909 non-null  int64         
     4   InvoiceDate  541909 non-null  datetime64[ns]
     5   UnitPrice    541909 non-null  float64       
     6   CustomerID   406829 non-null  object        
     7   Country      541909 non-null  object        
    dtypes: datetime64[ns](1), float64(1), int64(1), object(5)
    memory usage: 33.1+ MB
    None
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>



ğŸ” ê²°ì¸¡ ë°ì´í„° ì œê±°í•˜ê¸°


```python
df.isnull().sum()
```




    InvoiceNo           0
    StockCode           0
    Description      1454
    Quantity            0
    InvoiceDate         0
    UnitPrice           0
    CustomerID     135080
    Country             0
    dtype: int64




```python
df = df.dropna()
print(df.shape)
```

    (406829, 8)
    

ğŸ” íƒìƒ‰ ë°ì´í„°ì˜ ì¡°ê±´ í•„í„°ë§ : ìƒí’ˆ ìˆ˜ëŸ‰ì´ 0 ì´í•˜ì¸ ê²½ìš°


```python
# ìƒí’ˆ ìˆ˜ëŸ‰ì´ ìŒìˆ˜ì¸ ê²½ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤. 
print(df[df['Quantity'] <= 0].shape[0])
df = df[df['Quantity'] > 0]
```

    8905
    

ğŸ” íƒìƒ‰ ë°ì´í„°ì˜ ì¡°ê±´ í•„í„°ë§ : ìƒí’ˆ ê°€ê²©ì´ 0 ì´í•˜ì¸ ê²½ìš°


```python
# ìƒí’ˆ ê°€ê²©ì´ 0 ì´í•˜ì¸ ê²½ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤. 
print(df[df['UnitPrice'] <= 0].shape[0])
df = df[df['UnitPrice'] > 0]
```

    40
    

ğŸ” íƒìƒ‰ ë°ì´í„°ì˜ ì¡°ê±´ í•„í„°ë§ : ìƒí’ˆ ì½”ë“œê°€ ì¼ë°˜ì ì´ì§€ ì•Šì€ ê²½ìš°


```python
# ìƒí’ˆ ì½”ë“œê°€ ì¼ë°˜ì ì´ì§€ ì•Šì€ ê²½ìš°ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
df['ContainDigit'] = df['StockCode'].apply(lambda x : any(c.isdigit() for c in x))
print(df[df['ContainDigit'] == False].shape[0])
df[df['ContainDigit'] == False].head()
```

    1414
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>ContainDigit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45</th>
      <td>536370</td>
      <td>POST</td>
      <td>POSTAGE</td>
      <td>3</td>
      <td>2010-12-01 08:45:00</td>
      <td>18.00</td>
      <td>12583</td>
      <td>France</td>
      <td>False</td>
    </tr>
    <tr>
      <th>386</th>
      <td>536403</td>
      <td>POST</td>
      <td>POSTAGE</td>
      <td>1</td>
      <td>2010-12-01 11:27:00</td>
      <td>15.00</td>
      <td>12791</td>
      <td>Netherlands</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1123</th>
      <td>536527</td>
      <td>POST</td>
      <td>POSTAGE</td>
      <td>1</td>
      <td>2010-12-01 13:04:00</td>
      <td>18.00</td>
      <td>12662</td>
      <td>Germany</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2239</th>
      <td>536569</td>
      <td>M</td>
      <td>Manual</td>
      <td>1</td>
      <td>2010-12-01 15:35:00</td>
      <td>1.25</td>
      <td>16274</td>
      <td>United Kingdom</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2250</th>
      <td>536569</td>
      <td>M</td>
      <td>Manual</td>
      <td>1</td>
      <td>2010-12-01 15:35:00</td>
      <td>18.95</td>
      <td>16274</td>
      <td>United Kingdom</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>




```python
# ìƒí’ˆ ì½”ë“œê°€ ì¼ë°˜ì ì´ì§€ ì•Šì€ ê²½ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤. 
df = df[df['ContainDigit'] == True]
```

âœ… `ì—°ë§ì— ì˜¨ë¼ì¸ ìŠ¤í† ì–´ì— ë°©ë¬¸í•˜ëŠ” ìœ ì €ë“¤ì—ê²Œ ì–´ë–¤ ìƒí’ˆì„ ì¶”ì²œí•´ì¤„ ìˆ˜ ìˆì„ê¹Œ?`

ğŸ” ë°ì´í„°ì˜ ê¸°ê°„ íƒìƒ‰í•˜ê¸°


```python
# ê±°ë˜ ë°ì´í„°ì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„°ì™€ ê°€ì¥ ìµœì‹ ì˜ ë°ì´í„°ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
df['date'] = df['InvoiceDate'].dt.date
print(df['date'].min())
print(df['date'].max())
```

    2010-12-01
    2011-12-09
    

ğŸ” ì¼ìë³„ ê±°ë˜ ìˆ˜ëŸ‰ íƒìƒ‰í•˜ê¸°


```python
# ì¼ìë³„ ì´ ê±°ë˜ ìˆ˜ëŸ‰ì„ íƒìƒ‰í•©ë‹ˆë‹¤. 
date_quantity_series = df.groupby('date')['Quantity'].sum()
date_quantity_series.plot()
```




    <Axes: xlabel='date'>




    
![png](/assets/images/Book/9/output_15_1.png)
    


ğŸ” ì¼ìë³„ ê±°ë˜ íšŸìˆ˜ íƒìƒ‰í•˜ê¸°


```python
# ì¼ìë³„ ì´ ê±°ë˜ íšŸìˆ˜ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
date_transaction_series = df.groupby('date')['InvoiceNo'].nunique()
date_transaction_series.plot()
```




    <Axes: xlabel='date'>




    
![png](/assets/images/Book/9/output_17_1.png)
    


ğŸ” ì¼ìë³„ ê±°ë˜ ìƒí’ˆ ê°œìˆ˜ íƒìƒ‰í•˜ê¸°


```python
# ì¼ìë³„ ê±°ë˜ëœ ìƒí’ˆì˜ uniqueí•œ ê°œìˆ˜, ì¦‰ ìƒí’ˆ ê±°ë˜ ë‹¤ì–‘ì„±ì„ íƒìƒ‰í•©ë‹ˆë‹¤. 
date_unique_item_series = df.groupby('date')['StockCode'].nunique()
date_unique_item_series.plot()
```




    <Axes: xlabel='date'>




    
![png](/assets/images/Book/9/output_19_1.png)
    


ğŸ” ì „ì²´ ìœ ì €ì˜ ìˆ˜ íƒìƒ‰í•˜ê¸°


```python
# ì´ ìœ ì €ì˜ ìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤. 
print(len(df['CustomerID'].unique()))
```

    4334
    

ğŸ” ìœ ì €ë³„ ê±°ë˜ íšŸìˆ˜ íƒìƒ‰í•˜ê¸°


```python
# ìœ ì €ë³„ ê±°ë˜ íšŸìˆ˜ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
customer_unique_transaction_series = df.groupby('CustomerID')['InvoiceNo'].nunique()
customer_unique_transaction_series.describe()
```




    count    4334.000000
    mean        4.246654
    std         7.642535
    min         1.000000
    25%         1.000000
    50%         2.000000
    75%         5.000000
    max       206.000000
    Name: InvoiceNo, dtype: float64



ğŸ” ìœ ì €ë³„ ê±°ë˜ íšŸìˆ˜ ì‹œê°í™”í•˜ê¸°


```python
# ìƒì ê·¸ë¦¼ ì‹œê°í™”ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
plt.boxplot(customer_unique_transaction_series.values)
plt.show()
```


    
![png](/assets/images/Book/9/output_25_0.png)
    


ğŸ” ìœ ì €ë³„ ìƒí’ˆ êµ¬ë§¤ ì¢…ë¥˜ íƒìƒ‰í•˜ê¸°


```python
# ìœ ì €ë³„ ì•„ì´í…œ êµ¬ë§¤ ì¢…ë¥˜ ê°œìˆ˜ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
customer_unique_item_series = df.groupby('CustomerID')['StockCode'].nunique()
customer_unique_item_series.describe()
```




    count    4334.000000
    mean       61.432856
    std        85.312937
    min         1.000000
    25%        16.000000
    50%        35.000000
    75%        77.000000
    max      1786.000000
    Name: StockCode, dtype: float64



ğŸ” ìœ ì €ë³„ ìƒí’ˆ êµ¬ë§¤ ì¢…ë¥˜ ì‹œê°í™”í•˜ê¸°


```python
# ìƒì ê·¸ë¦¼ ì‹œê°í™”ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
plt.boxplot(customer_unique_item_series.values)
plt.show()
```


    
![png](/assets/images/Book/9/output_29_0.png)
    


ğŸ” ì¼ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ë¶„ë¦¬í•˜ê¸° 


```python
import datetime 

# 2011ë…„ 11ì›”ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ì—¬ ê¸°ì¤€ ì´ì „ê³¼ ì´í›„ë¡œ ë°ì´í„°ë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤. 
df_year_round = df[df['date'] < datetime.date(2011, 11, 1)] 
df_year_end = df[df['date'] >= datetime.date(2011, 11, 1)] 
print(df_year_round.shape)
print(df_year_end.shape)
```

    (314902, 10)
    (81568, 10)
    

ğŸ” 11ì›” ì´ì „ ìœ ì €ë³„ë¡œ êµ¬ë§¤í–ˆë˜ ìƒí’ˆì˜ ì§‘í•© ì¶”ì¶œí•˜ê¸° 


```python
# 11ì›” ì´ì „ ë°ì´í„°ì—ì„œ êµ¬ë§¤í–ˆë˜ ìƒí’ˆì˜ setì„ ì¶”ì¶œí•©ë‹ˆë‹¤. 
customer_item_round_set = df_year_round.groupby('CustomerID')['StockCode'].apply(set)
print(customer_item_round_set)
```

    CustomerID
    12346                                              {23166}
    12347    {84969, 84992, 47567B, 22992, 20780, 84625C, 2...
    12348    {84992, 21967, 22951, 23076, 84988, 21981, 230...
    12350    {21832, 21866, 79066K, 22557, 20652, 21908, 21...
    12352    {22844, 22701, 22654, 22779, 22423, 21232, 228...
                                   ...                        
    18280    {22467, 22725, 22499, 22084, 82484, 22180, 226...
    18281    {22467, 22028, 23209, 22037, 22716, 23008, 23007}
    18282    {23295, 23187, 22424, 21270, 21108, 22089, 21109}
    18283    {21166, 22653, 21826, 21828, 22896, 20718, 227...
    18287    {21014, 22758, 22582, 22583, 22807, 84920, 218...
    Name: StockCode, Length: 3970, dtype: object
    

ğŸ” ìœ ì €ë³„ êµ¬ë§¤ ì‚¬ì „ êµ¬ì¶•í•˜ê¸° 


```python
# 11ì›” ì´ì „ì— êµ¬ë§¤í–ˆëŠ”ì§€ í˜¹ì€ ì´í›„ì— êµ¬ë§¤í–ˆëŠ”ì§€ë¥¼ ìœ ì €ë³„ë¡œ ê¸°ë¡í•˜ê¸° ìœ„í•œ ì‚¬ì „ì„ ì •ì˜í•©ë‹ˆë‹¤. 
customer_item_dict = {} 

# 11ì›” ì´ì „ì— êµ¬ë§¤í•œ ìƒí’ˆì€ 'old'ë¼ê³  í‘œê¸°í•©ë‹ˆë‹¤. 
for customer_id, stocks in customer_item_round_set.items() : 
    customer_item_dict[customer_id] = {} 
    for stock_code in stocks : 
        customer_item_dict[customer_id][stock_code] = 'old' 

print(str(customer_item_dict)[:100] + "...")
```

    {'12346': {'23166': 'old'}, '12347': {'84969': 'old', '84992': 'old', '47567B': 'old', '22992': 'old...
    

ğŸ” 11ì›” ì´í›„ ìœ ì €ë³„ë¡œ êµ¬ë§¤í–ˆë˜ ìƒí’ˆì˜ ì§‘í•© ì¶”ì¶œí•˜ê¸° 


```python
# 11ì›” ì´í›„ ë°ì´í„°ì—ì„œ êµ¬ë§¤í•˜ëŠ” ìƒí’ˆì˜ ì§‘í•©ì„ ì¶”ì¶œí•©ë‹ˆë‹¤. 
customer_item_end_set = df_year_end.groupby('CustomerID')['StockCode'].apply(set)
print(customer_item_end_set)
```

    CustomerID
    12347    {20719, 23084, 23497, 23508, 21265, 23552, 232...
    12349    {23294, 21563, 22131, 23494, 21136, 22666, 215...
    12352    {22978, 22624, 23096, 23089, 22635, 22668, 229...
    12356                                       {21843, 22423}
    12357    {22846, 22718, 22306, 23493, 84029E, 22064, 23...
                                   ...                        
    18272    {23494, 22961, 22666, 22074, 20914, 23240, 234...
    18273                                             {79302M}
    18274    {84988, 21108, 22989, 22720, 21974, 22423, 232...
    18282                  {22699, 23174, 23175, 22423, 22818}
    18283    {84992, 20718, 21891, 20726, 21981, 23493, 235...
    Name: StockCode, Length: 1904, dtype: object
    

ğŸ” ìœ ì €ë³„ êµ¬ë§¤ ì‚¬ì „ ì—…ë°ì´íŠ¸í•˜ê¸°


```python
# 11ì›” ì´ì „ì—ë§Œ êµ¬ë§¤í•œ ìƒí’ˆì€ 'old', ì´í›„ì—ë§Œ êµ¬ë§¤í•œ ìƒí’ˆì€ 'new', ëª¨ë‘ êµ¬ë§¤í•œ ìƒí’ˆì€ 'both'ë¼ê³  í‘œê¸°í•©ë‹ˆë‹¤. 
for customer_id, stocks in customer_item_end_set.items() : 
    # 11ì›” ì´ì „ êµ¬ë§¤ê¸°ë¡ì´ ìˆëŠ” ìœ ì €ì¸ì§€ë¥¼ ì²´í¬í•©ë‹ˆë‹¤. 
    if customer_id in customer_item_dict : 
        for stock_code in stocks : 
            # êµ¬ë§¤í•œ ì  ìˆëŠ” ìƒí’ˆì¸ì§€ë¥¼ ì²´í¬í•œ ë’¤, ìƒíƒœë¥¼ í‘œê¸°í•©ë‹ˆë‹¤. 
            if stock_code in customer_item_dict[customer_id] : 
                customer_item_dict[customer_id][stock_code] = 'both'
            else : 
                customer_item_dict[customer_id][stock_code] = 'new'
    # 11ì›” ì´ì „ êµ¬ë§¤ê¸°ë¡ì´ ì—†ëŠ” ìœ ì €ë¼ë©´ ëª¨ë‘ 'new'ë¡œ í‘œê¸°í•©ë‹ˆë‹¤. 
    else : 
        customer_item_dict[customer_id] = {} 
        for stock_code in stocks : 
            customer_item_dict[customer_id][stock_code] = 'new' 

print(str(customer_item_dict)[:100] + "...")
```

    {'12346': {'23166': 'old'}, '12347': {'84969': 'old', '84992': 'old', '47567B': 'old', '22992': 'old...
    

ğŸ” êµ¬ë§¤ ì‚¬ì „ì„ ë°ì´í„° í”„ë ˆì„ìœ¼ë¡œ ì •ë¦¬í•˜ê¸°


```python
# 'old', 'new', 'both'ë¥¼ ìœ ì €ë³„ë¡œ íƒìƒ‰í•˜ì—¬ ë°ì´í„° í”„ë ˆì„ì„ ìƒì„±í•©ë‹ˆë‹¤. 
columns = ['CustomerID', 'old', 'new', 'both']
df_order_info = pd.DataFrame(columns = columns) 

# ë°ì´í„° í”„ë ˆì„ì„ ìƒì„±í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. 
for customer_id in customer_item_dict : 
    old = 0 
    new = 0 
    both = 0 

    # ìƒí’ˆ ìƒíƒœ(old, new, both)ë¥¼ ì²´í¬í•˜ì—¬ ë°ì´í„° í”„ë ˆì„ì— concatí•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. 
    for stock_code in customer_item_dict[customer_id] : 
        status = customer_item_dict[customer_id][stock_code]
        if status == 'old' : 
            old += 1 
        elif status == 'new' : 
            new += 1
        else : 
            both += 1
    # df_order_infoì— ë°ì´í„°ë¥¼ concatí•©ë‹ˆë‹¤. 
    row = [customer_id, old, new, both] 
    series = pd.Series(row, index=columns) 
    df_order_info = pd.concat([df_order_info, series.to_frame().T], ignore_index=True)

df_order_info.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>old</th>
      <th>new</th>
      <th>both</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347</td>
      <td>92</td>
      <td>3</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348</td>
      <td>21</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12350</td>
      <td>16</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12352</td>
      <td>43</td>
      <td>12</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>



ğŸ” ì¬êµ¬ë§¤, ì‹ ê·œ êµ¬ë§¤ ìœ ì € ë¶„ì„í•˜ê¸°


```python
# ë°ì´í„° í”„ë ˆì„ì—ì„œ ì „ì²´ ìœ ì € ìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. 
print(df_order_info.shape[0])

# ë°ì´í„° í”„ë ˆì„ì—ì„œ oldê°€ 1 ì´ìƒì´ë©´ì„œ, newê°€ 1 ì´ìƒì¸ ìœ ì € ìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. 
# 11ì›” ì´í›„ì— ê¸°ì¡´ì— êµ¬ë§¤í•œ ì  ì—†ëŠ” ìƒˆë¡œìš´ ìƒí’ˆì„ êµ¬ë§¤í•œ ìœ ì €ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. 
print(df_order_info[(df_order_info['old'] > 0) & (df_order_info['new'] > 0)].shape[0])

# ë°ì´í„° í”„ë ˆì„ì—ì„œ bothê°€ 1 ì´ìƒì¸ ìœ ì € ìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. 
# ì¬êµ¬ë§¤í•œ ìƒí’ˆì´ ìˆëŠ” ìœ ì € ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. 
print(df_order_info[df_order_info['both'] > 0].shape[0])
```

    4334
    1446
    1426
    

ğŸ” ì‹ ê·œ êµ¬ë§¤ ìƒí’ˆ ì¢…ë¥˜ íƒìƒ‰í•˜ê¸°


```python
# ë§Œì•½ ìƒˆë¡œìš´ ìƒí’ˆì„ êµ¬ë§¤í•œë‹¤ë©´ ì–¼ë§ˆë‚˜ ë§ì€ ì¢…ë¥˜ì˜ ìƒˆë¡œìš´ ìƒí’ˆì„ êµ¬ë§¤í•˜ëŠ”ì§€ íƒìƒ‰í•©ë‹ˆë‹¤. 
print(df_order_info['new'].value_counts()[1:].describe())
```

    count    132.000000
    mean      13.734848
    std       19.130672
    min        1.000000
    25%        1.000000
    50%        5.000000
    75%       16.000000
    max       81.000000
    Name: count, dtype: float64
    

### í‘œë¡œ ì •ë¦¬í•˜ëŠ” ë°ì´í„° ë¶„ì„

|ë°ì´í„° íƒìƒ‰ ì£¼ì œ|ì¸ì‚¬ì´íŠ¸|
|-|-|
|ì¼ìë³„ ê±°ë˜ ë°ì´í„°|ê±°ë˜ ìˆ˜ëŸ‰, íšŸìˆ˜, ìƒí’ˆì˜ ê°œìˆ˜ ëª¨ë‘ 10 ~ 11ì›”ì„ ê¸°ì ìœ¼ë¡œ ìƒìŠ¹í•¨.| 
|ìœ ì €ë³„ ê±°ë˜ íšŸìˆ˜|ìœ ì €ë³„ êµ¬ë§¤ íšŸìˆ˜ëŠ” ì¼ë°˜ì ìœ¼ë¡œ 1 ~ 5 ì‚¬ì´ì— ë¶„í¬ë˜ì–´ìˆìŒ.|
|ìœ ì €ë³„ êµ¬ë§¤ ìƒí’ˆ ì¢…ë¥˜|ìœ ì €ë³„ êµ¬ë§¤ ìƒí’ˆ ì¢…ë¥˜ëŠ” ë‹¤ì–‘í•œ í¸ì´ë©°, ìœ ì €ë‹¹ ì•½ ìˆ˜ì‹­ ì—¬ ê°œì˜ ìƒí’ˆì„ êµ¬ë§¤í•œë‹¤ê³  í•  ìˆ˜ ìˆìŒ.|
|ìœ ì €ë³„ ì¬êµ¬ë§¤, ì‹ ê·œ êµ¬ë§¤|11ì›”ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ë©´ ì „ì²´ ìœ ì € ì¤‘, 3ë¶„ì˜ 1ì€ ì¬êµ¬ë§¤ë¥¼ í•˜ì˜€ê³  3ë¶„ì˜ 1ì€ ì‹ ê·œ êµ¬ë§¤ë¥¼ í•˜ì˜€ìŒ.|
|ì‹ ê·œ êµ¬ë§¤ ìƒí’ˆ ì¢…ë¥˜|ì‹ ê·œ êµ¬ë§¤ ìœ ì €ì˜ ê²½ìš°, ê¸°ì¡´ êµ¬ë§¤ ì¢…ë¥˜ì— ë¹„í•´ ë§ì€ ì¢…ë¥˜ì˜ ìƒí’ˆì„ êµ¬ë§¤í•˜ì§€ëŠ” ì•Šì•˜ìŒ.|

## ì˜ˆì¸¡ ë¶„ì„ : SVDë¥¼ í™œìš©í•œ ìƒí’ˆ êµ¬ë§¤ ì˜ˆì¸¡í•˜ê¸°

ğŸ” ì¶”ì²œ ëŒ€ìƒì¸ ìœ ì €ì™€ ìƒí’ˆ ì¶œë ¥í•˜ê¸°


```python
# ì¶”ì²œ ëŒ€ìƒ ë°ì´í„°ì— í¬í•¨ë˜ëŠ” ìœ ì €ì™€ ìƒí’ˆì˜ ê°œìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. 
print(len(df_year_round['CustomerID'].unique()))
print(len(df_year_round['StockCode'].unique()))
```

    3970
    3608
    

ğŸ” SVD ëª¨ë¸ì— ì‚¬ìš©í•  Rating íƒìƒ‰í•˜ê¸°


```python
# Rating ë°ì´í„°ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ íƒìƒ‰ : ìœ ì € - ìƒí’ˆê°„ êµ¬ë§¤ íšŸìˆ˜ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
uir_df = df_year_round.groupby(['CustomerID', 'StockCode'])['InvoiceNo'].nunique().reset_index()
uir_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>StockCode</th>
      <th>InvoiceNo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346</td>
      <td>23166</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347</td>
      <td>16008</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12347</td>
      <td>17021</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12347</td>
      <td>20665</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12347</td>
      <td>20719</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Rating(InvoiceNo) í”¼ì²˜ì˜ ë¶„í¬ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
uir_df['InvoiceNo'].hist(bins = 20, grid = False)
```




    <Axes: >




    
![png](/assets/images/Book/9/output_50_1.png)
    


ğŸ” Log Normalization ì ìš©í•˜ê¸°


```python
# Rating(InvoiceNo) í”¼ì²˜ë¥¼ log normalization í•´ì¤€ ë’¤, ë‹¤ì‹œ ë¶„í¬ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. 
uir_df['InvoiceNo'].apply(lambda x : np.log10(x) + 1).hist(bins = 20, grid = False)
```




    <Axes: >




    
![png](/assets/images/Book/9/output_52_1.png)
    


ğŸ” í”¼ì²˜ ìŠ¤ì¼€ì¼ë§ ì ìš©í•˜ê¸°


```python
# 1 ~ 5 ì‚¬ì´ì˜ ì ìˆ˜ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. 
uir_df['Rating'] = uir_df['InvoiceNo'].apply(lambda x : np.log10(x) + 1) 
uir_df['Rating'] = ((uir_df['Rating'] - uir_df['Rating'].min()) / (uir_df['Rating'].max() - uir_df['Rating'].min()) * 4) + 1
uir_df['Rating'].hist(bins = 20, grid = False)
```




    <Axes: >




    
![png](/assets/images/Book/9/output_54_1.png)
    


ğŸ” SVD ëª¨ë¸ í•™ìŠµì„ ìœ„í•œ ë°ì´í„°ì…‹ ìƒì„±í•˜ê¸°


```python
# SVD ëª¨ë¸ í•™ìŠµì„ ìœ„í•œ ë°ì´í„°ì…‹ì„ ìƒì„±í•©ë‹ˆë‹¤. 
uir_df = uir_df[['CustomerID', 'StockCode', 'Rating']]
uir_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>StockCode</th>
      <th>Rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346</td>
      <td>23166</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347</td>
      <td>16008</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12347</td>
      <td>17021</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12347</td>
      <td>20665</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12347</td>
      <td>20719</td>
      <td>2.048881</td>
    </tr>
  </tbody>
</table>
</div>



ğŸ” SVD ëª¨ë¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸í•˜ê¸° 


```python
import time 
from surprise import SVD, Dataset, Reader, accuracy 
from surprise.model_selection import train_test_split

# SVD ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í•™ìŠµ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ëŒ€ëµì ì¸ ì„±ëŠ¥ì„ ì•Œì•„ë³´ê¸° ìœ„í•´ í•™ìŠµ ë°ì´í„°ì™€ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ 8:2ë¡œ ë¶„í• í•©ë‹ˆë‹¤. 
reader = Reader(rating_scale = (1, 5))
data = Dataset.load_from_df(uir_df[['CustomerID', 'StockCode', 'Rating']], reader)
train_data = data.build_full_trainset()

# SVD ëª¨ë¸ì„ í•™ìŠµí•©ë‹ˆë‹¤. 
train_start = time.time()
model = SVD(n_factors = 8, 
            lr_all = 0.005, 
            reg_all = 0.02, 
            n_epochs = 200) 
model.fit(train_data) 
train_end = time.time()
```

## ì˜ˆì¸¡ í‰ê°€ : ìƒí’ˆ ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸°

ğŸ” ì²« ë²ˆì§¸ ì¶”ì²œ ëŒ€ìƒì˜ ìœ ì €-ìƒí’ˆ ì ìˆ˜ ì¶”ì¶œí•˜ê¸° 


```python
# ì´ì „ì— êµ¬ë§¤í•˜ì§€ ì•Šì•˜ë˜ ìƒí’ˆì„ ì˜ˆì¸¡ì˜ ëŒ€ìƒìœ¼ë¡œ ì„ ì •í•©ë‹ˆë‹¤. 
test_data = train_data.build_anti_testset()
target_user_predictions = model.test(test_data) 

# êµ¬ë§¤ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë³€í™˜í•©ë‹ˆë‹¤. 
new_order_prediction_dict = {} 
for customer_id, stock_code, _, predicted_rating, _ in target_user_predictions : 
    if customer_id in new_order_prediction_dict : 
        if stock_code in new_order_prediction_dict[customer_id] : 
            pass 
        else : 
            new_order_prediction_dict[customer_id][stock_code] = predicted_rating 
    else : 
        new_order_prediction_dict[customer_id] = {} 
        new_order_prediction_dict[customer_id][stock_code] = predicted_rating 

print(str(new_order_prediction_dict)[:300] + "...")
```

    {'12346': {'16008': 1.0185701789599844, '17021': 1.0943822284400546, '20665': 1.0481631827712063, '20719': 1.127347702510006, '20780': 1, '20782': 1.1087520585122181, '20966': 1.0445170229453855, '21035': 1.1167140348232458, '21041': 1.112199518043685, '21064': 1.11098571376914, '21154': 1.027506075...
    

ğŸ” ë‘ ë²ˆì§¸ ì¶”ì²œ ëŒ€ìƒì˜ ìœ ì €-ìƒí’ˆ ì ìˆ˜ ì¶”ì¶œí•˜ê¸°


```python
# ì´ì „ì— êµ¬ë§¤í–ˆì—ˆë˜ ìƒí’ˆì„ ì˜ˆì¸¡ì˜ ëŒ€ìƒìœ¼ë¡œ ì„ ì •í•©ë‹ˆë‹¤. 
test_data = train_data.build_testset() 
target_user_predictions = model.test(test_data) 

# êµ¬ë§¤ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë³€í™˜í•©ë‹ˆë‹¤. 
reorder_prediction_dict = {} 
for customer_id, stock_code, _, predicted_rating, _ in target_user_predictions : 
    if customer_id in reorder_prediction_dict : 
        if stock_code in reorder_prediction_dict[customer_id] : 
            pass
        else : reorder_prediction_dict[customer_id][stock_code] = predicted_rating
    else : 
        reorder_prediction_dict[customer_id] = {} 
        reorder_prediction_dict[customer_id][stock_code] = predicted_rating

print(str(reorder_prediction_dict)[:300] + "...")
```

    {'12346': {'23166': 1.0740004091551671}, '12347': {'16008': 1, '17021': 1.3678352764261992, '20665': 1.0854298650154166, '20719': 2.0539193040055275, '20780': 1, '20782': 1.182287470877375, '20966': 1.1263446293208914, '21035': 1.3525913165787895, '21041': 1.4701066466378159, '21064': 1.231397088596...
    

ğŸ” ì„¸ ë²ˆì§¸ ì¶”ì²œ ëŒ€ìƒì˜ ìœ ì €-ìƒí’ˆ ì ìˆ˜ ì¶”ì¶œí•˜ê¸°


```python
# ë‘ ë”•ì…”ë„ˆë¦¬ë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤. 
total_prediction_dict = {} 

# new_order_prediction_dict ì •ë³´ë¥¼ ìƒˆë¡œìš´ ë”•ì…”ë„ˆë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤. 
for customer_id in new_order_prediction_dict : 
    if customer_id not in total_prediction_dict : 
        total_prediction_dict[customer_id] = {} 
    for stock_code, predicted_rating in new_order_prediction_dict[customer_id].items() : 
        if stock_code not in total_prediction_dict[customer_id] : 
            total_prediction_dict[customer_id][stock_code] = predicted_rating 

# reorder_prediction_dict ì •ë³´ë¥¼ ìƒˆë¡œìš´ ë”•ì…”ë„ˆë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤. 
for customer_id in reorder_prediction_dict : 
    if customer_id not in total_prediction_dict : 
        total_prediction_dict[customer_id] = {} 
    for stock_code, predicted_rating in reorder_prediction_dict[customer_id].items() : 
        if stock_code not in total_prediction_dict[customer_id] : 
            total_prediction_dict[customer_id][stock_code] = predicted_rating 

print(str(total_prediction_dict)[:300] + "...")
```

    {'12346': {'16008': 1.0185701789599844, '17021': 1.0943822284400546, '20665': 1.0481631827712063, '20719': 1.127347702510006, '20780': 1, '20782': 1.1087520585122181, '20966': 1.0445170229453855, '21035': 1.1167140348232458, '21041': 1.112199518043685, '21064': 1.11098571376914, '21154': 1.027506075...
    

ğŸ” ì‹œë®¬ë ˆì´ì…˜ì„ í…ŒìŠ¤íŠ¸í•  ë°ì´í„° í”„ë ˆì„ ìƒì„±í•˜ê¸° 


```python
# 11ì›” ì´í›„ì˜ ë°ì´í„°ë¥¼ í…ŒìŠ¤íŠ¸ ë°ì´í„°ì…‹ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ë°ì´í„° í”„ë ˆì„ì„ ìƒì„±í•©ë‹ˆë‹¤. 
simulation_test_df = df_year_end.groupby('CustomerID')['StockCode'].apply(set).reset_index()
simulation_test_df.columns = ['CustomerID', 'RealOrdered']
simulation_test_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>RealOrdered</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12347</td>
      <td>{20719, 23084, 23497, 23508, 21265, 23552, 232...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12349</td>
      <td>{23294, 21563, 22131, 23494, 21136, 22666, 215...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12352</td>
      <td>{22978, 22624, 23096, 23089, 22635, 22668, 229...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12356</td>
      <td>{21843, 22423}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12357</td>
      <td>{22846, 22718, 22306, 23493, 84029E, 22064, 23...</td>
    </tr>
  </tbody>
</table>
</div>



ğŸ” ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ì¶”ê°€í•˜ê¸°


```python
# ì´ ë°ì´í„° í”„ë ˆì„ì— ìƒí’ˆ ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. 
def add_predicted_stock_set(customer_id, prediction_dict) : 
    if customer_id in prediction_dict : 
        predicted_stock_dict = prediction_dict[customer_id] 
        # ì˜ˆì¸¡ëœ ìƒí’ˆì˜ Ratingì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤. 
        sorted_stocks = sorted(predicted_stock_dict, key = lambda x : predicted_stock_dict[x], reverse = True)
        return sorted_stocks
    else : 
        return None 

# ìƒí’ˆ ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. 
simulation_test_df['PredictedOrder(New)'] = simulation_test_df['CustomerID'].apply(lambda x : add_predicted_stock_set(x, new_order_prediction_dict))
simulation_test_df['PredictedOrder(Reorder)'] = simulation_test_df['CustomerID'].apply(lambda x : add_predicted_stock_set(x, reorder_prediction_dict))
simulation_test_df['PredictedOrder(Total)'] = simulation_test_df['CustomerID'].apply(lambda x : add_predicted_stock_set(x, total_prediction_dict))

simulation_test_df.head()                                                                                   
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>RealOrdered</th>
      <th>PredictedOrder(New)</th>
      <th>PredictedOrder(Reorder)</th>
      <th>PredictedOrder(Total)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12347</td>
      <td>{20719, 23084, 23497, 23508, 21265, 23552, 232...</td>
      <td>[22616, 22356, 22629, 20725, 20727, 23206, 207...</td>
      <td>[22728, 22726, 20719, 22727, 22371, 22725, 227...</td>
      <td>[22616, 22728, 22726, 22356, 22629, 20725, 207...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12349</td>
      <td>{23294, 21563, 22131, 23494, 21136, 22666, 215...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12352</td>
      <td>{22978, 22624, 23096, 23089, 22635, 22668, 229...</td>
      <td>[84086B, 90119, 85131B, 90035A, 90042A, 20816,...</td>
      <td>[37448, 22779, 21754, 22413, 22645, 22138, 224...</td>
      <td>[84086B, 90119, 85131B, 90035A, 90042A, 20816,...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12356</td>
      <td>{21843, 22423}</td>
      <td>[84086B, 85131B, 90119, 22197, 90035A, 90042A,...</td>
      <td>[22423, 37450, 22649, 22699, 21843, 21080, 210...</td>
      <td>[84086B, 85131B, 90119, 22197, 90035A, 90042A,...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12357</td>
      <td>{22846, 22718, 22306, 23493, 84029E, 22064, 23...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div>



ğŸ” ìƒí’ˆ ì¶”ì²œ í‰ê°€ ê¸°ì¤€ ì •ì˜í•˜ê¸° 


```python
# êµ¬ë§¤ ì˜ˆì¸¡ì˜ ìƒìœ„ kê°œì˜ recall(ì¬í˜„ìœ¨)ì„ í‰ê°€ ê¸°ì¤€ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤. 
def calculate_recall(real_order, predicted_order, k) : 
    # ë§Œì•½ ì¶”ì²œ ëŒ€ìƒ ìƒí’ˆì´ ì—†ë‹¤ë©´, 11ì›” ì´í›„ì— ìƒí’ˆì„ ì²˜ìŒ êµ¬ë§¤í•˜ëŠ” ìœ ì €ì…ë‹ˆë‹¤. 
    if predicted_order is None : 
        return None 

    # SVD ëª¨ë¸ì—ì„œ í˜„ì¬ ìœ ì €ì˜ Ratingì´ ë†’ì€ ìƒìœ„ kê°œì˜ ìƒí’ˆì„ 'êµ¬ë§¤í•  ê²ƒìœ¼ë¡œ ì˜ˆì¸¡' í•©ë‹ˆë‹¤. 
    predicted = predicted_order[:k]
    true_positive = 0 
    for stock_code in predicted : 
        if stock_code in real_order : 
            true_positive += 1

    # ì˜ˆì¸¡í•œ ìƒí’ˆ ì¤‘, ì‹¤ì œë¡œ ìœ ì €ê°€ êµ¬ë§¤í•œ ìƒí’ˆì˜ ë¹„ìœ¨(recall)ì„ ê³„ì‚°í•©ë‹ˆë‹¤. 
    recall = true_positive / len(predicted) 
    return recall 
```

ğŸ” ìƒí’ˆ ì¶”ì²œ í‰ê°€í•˜ê¸° 


```python
# ì‹œë®¬ë ˆì´ì…˜ ëŒ€ìƒ ìœ ì €ì—ê²Œ ìƒí’ˆì„ ì¶”ì²œí•´ì¤€ ê²°ê³¼ë¥¼ í‰ê°€í•©ë‹ˆë‹¤. 
simulation_test_df['top_k_recall(Reorder)'] = simulation_test_df.apply(lambda x : calculate_recall(x['RealOrdered'], x['PredictedOrder(Reorder)'], 5), axis = 1)
simulation_test_df['top_k_recall(New)'] = simulation_test_df.apply(lambda x : calculate_recall(x['RealOrdered'], x['PredictedOrder(New)'], 5), axis = 1)
simulation_test_df['top_k_recall(Total)'] = simulation_test_df.apply(lambda x : calculate_recall(x['RealOrdered'], x['PredictedOrder(Total)'], 5), axis = 1)
```

ğŸ” í‰ê°€ ê²°ê³¼ ì¶œë ¥í•˜ê¸°


```python
# í‰ê°€ ê²°ê³¼ë¥¼ ìœ ì €í‰ê· ìœ¼ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
print(simulation_test_df['top_k_recall(Reorder)'].mean())
print(simulation_test_df['top_k_recall(New)'].mean())
print(simulation_test_df['top_k_recall(Total)'].mean())
```

    0.3113961038961039
    0.007662337662337663
    0.07298701298701298
    

ğŸ” ì¬êµ¬ë§¤ ìƒí’ˆ ì¶”ì²œì˜ ìƒì„¸ ê²°ê³¼ 


```python
# í‰ê°€ ê²°ê³¼ë¥¼ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
simulation_test_df['top_k_recall(Reorder)'].value_counts()
```




    top_k_recall(Reorder)
    0.000000    454
    0.200000    421
    0.400000    281
    0.600000    166
    0.800000    122
    1.000000     77
    0.500000      7
    0.250000      6
    0.666667      4
    0.750000      1
    0.333333      1
    Name: count, dtype: int64



ğŸ” ì‹ ê·œ ìƒí’ˆ ì¶”ì²œì˜ ìƒì„¸ ê²°ê³¼


```python
# í‰ê°€ ê²°ê³¼ë¥¼ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
simulation_test_df['top_k_recall(New)'].value_counts()
```




    top_k_recall(New)
    0.0    1491
    0.2      40
    0.4       8
    0.6       1
    Name: count, dtype: int64



ğŸ” ì „ì²´ ìƒí’ˆ ì¶”ì²œì˜ ìƒì„¸ ê²°ê³¼


```python
# í‰ê°€ ê²°ê³¼ë¥¼ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì‚´í´ë´…ë‹ˆë‹¤. 
simulation_test_df['top_k_recall(Total)'].value_counts()
```




    top_k_recall(Total)
    0.0    1216
    0.2     182
    0.4      76
    0.6      43
    0.8      16
    1.0       7
    Name: count, dtype: int64



ğŸ” ì‹œë®¬ë ˆì´ì…˜ ìµœì¢… ê²°ê³¼ ì •ë¦¬


```python
# ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ ì‚´í´ë´…ë‹ˆë‹¤. 
k = 5 
result_df = simulation_test_df[simulation_test_df['PredictedOrder(Reorder)'].notnull()]
result_df['PredictedOrder(Reorder)'] = result_df['PredictedOrder(Reorder)'].apply(lambda x : x[:k])
result_df = result_df[['CustomerID', 'RealOrdered', 'PredictedOrder(Reorder)', 'top_k_recall(Reorder)']]
result_df.columns = [['êµ¬ë§¤ìID', 'ì‹¤ì œì£¼ë¬¸', '5ê°œì¶”ì²œê²°ê³¼', 'Top5ì¶”ì²œ_ì£¼ë¬¸ì¬í˜„ë„']]
result_df.sample(5).head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>êµ¬ë§¤ìID</th>
      <th>ì‹¤ì œì£¼ë¬¸</th>
      <th>5ê°œì¶”ì²œê²°ê³¼</th>
      <th>Top5ì¶”ì²œ_ì£¼ë¬¸ì¬í˜„ë„</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>921</th>
      <td>15163</td>
      <td>{23335, 21790, 23186, 22491, 22734, 22910, 232...</td>
      <td>[47566, 20972, 22201, 22147, 22149]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>369</th>
      <td>13450</td>
      <td>{22560, 21212, 21892, 22561, 22568, 22196, 229...</td>
      <td>[22569, 22570, 22620, 22993, 22960]</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>1294</th>
      <td>16434</td>
      <td>{23103, 23196, 84946, 23323, 23150, 22078, 356...</td>
      <td>[22178, 47566, 84946, 22151, 22720]</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>322</th>
      <td>13292</td>
      <td>{22469, 23215, 22139, 22178, 23223, 21889, 235...</td>
      <td>[22423, 22077, 84978, 21136, 22168]</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>1778</th>
      <td>17865</td>
      <td>{22997, 85150, 21908, 21668, 35924, 85152, 825...</td>
      <td>[82582, 82600, 21165, 85152, 21175]</td>
      <td>0.8</td>
    </tr>
  </tbody>
</table>
</div>



## í‘œë¡œ ì •ë¦¬í•˜ëŠ” ë°ì´í„° ë¶„ì„

|ì£¼ìš” í‚¤ì›Œë“œ|í•µì‹¬ ë‚´ìš©|ì„¤ëª…|
|-|-|-|
|ë¶„ì„ ë°©í–¥ ì„¤ì •í•˜ê¸°|íƒìƒ‰ì  ë¶„ì„(EDA)ì„ í™œìš©í•˜ì—¬ ì „ì²´ ë¶„ì„ ë°©í–¥ì„ ìˆ˜ë¦½|íƒìƒ‰ì  ë°ì´í„° ë¶„ì„ì„ í†µí•´ ë¶„ì„ ì „ì²´ì˜ ë°©í–¥ì„±ì„ ìˆ˜ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆì œì˜ ê²½ìš°, ìœ ì €ì˜ êµ¬ë§¤ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìƒí’ˆ ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜ì˜ ì¢…ë¥˜ë¥¼ ë‚˜ëˆ„ì—ˆê³ , SVD ë¶„ì„ì„ ìœ„í•œ í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ì˜ íŒíŠ¸ë¥¼ ë°œê²¬í•˜ì˜€ìŠµë‹ˆë‹¤.|
|í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§|ë¡œê·¸ë¥¼ í†µí•œ í”¼ì²˜ ì •ê·œí™”(Log Norma;lization)|ì™œë„(Skewness: í•œìª½ìœ¼ë¡œ ê¸´ ê¼¬ë¦¬ë¥¼ ê°€ì§„ í˜•íƒœì˜ ë¹„ëŒ€ì¹­ì ì¸ ë¶„í¬ ì •ë„)ê°€ ë†’ì€ ë°ì´í„°ì˜ ê²½ìš°, ë¡œê·¸ë¥¼ í†µí•œ í”¼ì²˜ ì •ê·œí™”ë¥¼ í™œìš©í•˜ì—¬ ì¡°ê¸ˆ ë” ëª¨ë¸ í•™ìŠµì— ì í•©í•œ í˜•íƒœë¡œ ë³€í™˜í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.|
|SVDëª¨ë¸ì„ í™œìš©í•œ ìƒí’ˆ ì¶”ì²œ|í–‰ë ¬ ì™„ì„±ì„ ì´ìš©í•œ ìœ ì €-ìƒí’ˆ ê°„ ì ìˆ˜ ì˜ˆì¸¡|ìœ ì €-ìƒí’ˆ ê°„ì˜ ì ìˆ˜ë¥¼ ì˜ˆì¸¡í•˜ê³ , ê²°ê³¼ë¥¼ ì •ë ¬í•˜ì—¬ ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ëª…ì‹œëœ Ratingì´ ì—†ëŠ” ë°ì´í„°ì—ì„œëŠ” í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ìœ¼ë¡œ ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.|
|í‰ê°€ ê¸°ì¤€ ìˆ˜ë¦½í•˜ê¸°|ì¬í˜„ë„ë¡œ í‰ê°€í•˜ëŠ” êµ¬ë§¤ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜|ì‹œë®¬ë ˆì´ì…˜ ê³¼ì •ì„ ê±°ì³ ì¶”ì²œëœ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì¤‘ ì–´ëŠ ì •ë„ì˜ ë¹„ìœ¨ë¡œ ì‹¤ì œ êµ¬ë§¤ë¥¼ ì˜ˆì¸¡í–ˆëŠ”ì§€ í‰ê°€í•˜ê¸° ìœ„í•´ Confusion matrixì˜ ì¬í˜„ë„(Recall)ë¥¼ í™œìš©í•˜ì˜€ìŠµë‹ˆë‹¤.|
